#summary Developer guide for TorAS developers.
#labels ActionScript,TorAS,DevelopersGuide,setup,configuration

= Introduction =

The TorAS source code attempts to be autonomous and unobtrusive, reducing the dependence on the developer to create complex setups and connections with the Tor services.

For this reason, TorAS comes with a number of default settings and pre-configurations intended to start the services automatically. While this will probably be sufficient for most developers, at least initially, it's wortwhile to become familiar with the rudimentary operation of TorAS.

It is assumed that developers using TorAS have some knowledge with ActionScript (creating class instances, calling methods, working with data, etc.)

Additionally, while TorAS provides a simplified way to access the Tor services, developers should refer to the Tor Protocol Specification for a complete and authoritative source of information:

http://code.google.com/p/toras/wiki/TorProtocolSpecification_v1

= Configuration =

The TorControl class is responsible for getting the Tor services binary up and running. If you plan to start the Tor binary manually, or if it's already running, you can skip this section entirely.

TorControl configures the Tor services binary by dynamically creating a configuration file (torcc), writing it to the default application storage directory (File.applicationStorageDirectory), and then instructing Tor to load it as part of startup ("tor.exe -f /AppStorageDirectory/torcc").

The default contents of this file are stored in the TorControl class in the configData property:

{{{public static const configData:XML =<config><![CDATA[# TorAS Dynamic Configuration -- generated by TorControl.as
ControlPort %control_port%
ControlListenAddress %control_ip%
ClientOnly 1
SOCKSListenAddress %socks_ip%:%socks_port%
]]></config>}}}

Because this data is stored as XML, it is required to be stored within at least one top-level parent node. Although the name "config" is used for this node, any value XML node name is acceptable since it's only the contents of this node that are used.

To supply TorControl with a custom configuration file, developers can assign this XML data, in the same format as specified, to the TorControl instance's "config" property, at any time prior to calling "connect".

= Configuration Metatags =

The configuration data currently supports 5 metatags, or special strings, which are replaced by custom (or default) settings that are passed to the TorControl instance. These include:

*%control_ip%* : The IP address used by the running Tor control services socket for control and status commands. This string will be replaced by the IP specified in the TorControl constructor (or the default control IP "127.0.0.1" if not customized). Although the name "localhost" may work here, it is advisable to use the direct IP instead.

*%control_port%* : The port used by the running Tor control services socket for control and status commands. This string will be replaced by the port specified in the TorControl constructor (or the default control port 9151 if not customized).

*%socks_ip%* : The IP address used by the running Tor services socket for sending and receiving network requests (for example, HTTP requests). This string will be replaced by the IP specified in the TorControl constructor (or the default SOCKS IP "127.0.0.1" if not customized). Although the name "localhost" may work here, it is advisable to use the direct IP instead.

*%socks_port%* : The port used by the running Tor services socket for sending and receiving network requests. This string will be replaced by the IP specified in the TorControl constructor (or the default SOCKS port 1080 if not customized). 

*%control_passhash%* : The hashed password to use for authentication with the Tor control services socket. NOT CURRENTLY USED!

Using all default values, the built-in configuration data (after metatag parsing), would look like this:

{{{# TorAS Dynamic Configuration -- generated by TorControl.as
ControlPort 9151
ControlListenAddress 127.0.0.1
ClientOnly 1
SOCKSListenAddress 127.0.0.1:1080}}}

It is perfectly valid to hardcode these configuration values as in the above, post-metatag-parse data. However, it is adviseable to keep configuration data dynamic and instead use TorControl instantiation parameters for easier future updates and maintainability.

Many additional starup configuration options are available for use with this configuration data. Please refer to the complete list at:

https://www.torproject.org/docs/tor-manual-dev.html

= Starting the TorAS Control Connection =

As mentioned in a previous section, if you don't plan on using TorControl to launch the Tor services binary from within an AIR application, you will need to launch the Tor binary manually. Be sure to note imporant information such as the control IP, control port, SOCKS5 IP, SOCKS5 port, and control password hash -- these will need to be supplied to TorControl at instantiation.

If you're using TorControl to launch the Tor services binary, ensure that you've created valid config data in the step above first. Take extra care to ensure that vital information such as IPs and ports match between TorControl and the Tor config (especially if using non-dynamic, non-metatag data).

Starting TorControl is a simple process. First you need to create the TorControl instance:

{{{var torControl:TorControl=new TorControl();}}}

To use non-standard port/IP settings, provide these to the constructor. For exaample, if you're using the control address 127.0.0.1:9050 and the SOCKS5 address 127.0.0.1:8050, you would create the TorControl instance like this:

{{{var torControl:TorControl=new TorControl("127.0.0.1", 9050, "127.0.0.1", 8050);}}}

If you're using the dynamic config option for the Tor services binary, the next step is to assign the config data to the "config" property of the instance:

{{{torControl.config=<config>
ControlPort 9050
...}}}

At this point, you can set up listeners to any of the optional TorAS events:

http://code.google.com/p/toras/wiki/TorASEvents

The one event that it is highly recommended that you listen to is "TorControlEvent.ONAUTHENTICATE". This event will be broadcast by TorAS once a connection has been established and authenticated (commands may not be issued until both conditions are true).

If you don't want TorControl to automatically launch the Tor services binary, set the "launchServices" property to _false_ at this point (default is _true_):

{{{torControl.launchServices=false;}}}

The final step in establishing a connection to the running Tor control services is to call the "connect" method of the TorControl instance:

{{{torControl.connect();}}}

If properly configured and enabled, this will automate the launch, configuration, and initial connection(s) of the Tor services binary.

The benefit of using TorControl to launch the Tor services binary is that you will also be able to observe STDOUT messages -- the Tor binary version of the ActionScript "trace" commands. These messages can be received by listening to the "TorControlEvent.ONLOGMSG" event. If you are launching the Tor services binary manually, this event will never be dispatched.

Putting all of this together, starting up TorControl using default values may look something like this:

{{{import org.torproject.TorControl;
import org.torproject.events.TorControlEvent;
var torControl:TorControl=new TorControl();
torControl.addEventListener(TorControlEvent.ONAUTHENTICATE, this.onTorReady);
torControl.connect();
function onTorReady(eventObj:TorControlEvent):void {
   trace ("Tor control connection is authenticated and ready.");
}}}}